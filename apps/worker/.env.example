# 应用环境名称
ENVIRONMENT=dev

# 推荐：优先使用仓库根目录 `.env`（参考 `<repo_root>/.env.example`）统一管理配置。
# 该文件保留用于兼容单应用配置，变量与根目录 `.env` 一致。

# Redis 连接（同时作为 Celery broker 和 result backend）
REDIS_URL=redis://localhost:6379/0

# 模型根目录（可选），默认使用 <repo_root>/models
# 若通过 scripts/dev_worker.sh / scripts/dev_all.sh 启动，cwd 会在仓库根目录，
# 因此可以使用相对路径（直接给出默认值，方便修改）：
MODELS_DIR=models

# Z-Image 推理相关配置
Z_IMAGE_VARIANT=turbo

# 可选：Worker 使用的设备（不设置时自动检测 CUDA，否则回退到 CPU）
# 在多 GPU 机器上，推荐通过外部环境变量 GPU_ID 来设置：
#   GPU_ID=0 scripts/dev_worker.sh   → Z_IMAGE_DEVICE=cuda:0
#   GPU_ID=1 scripts/dev_worker.sh   → Z_IMAGE_DEVICE=cuda:1
# 也可以直接在此处写死：
# Z_IMAGE_DEVICE=cuda:0

# ---- DFloat11 模式（默认开启）----
# 若已经构建好一个 DF11 仓库（例如 models/z-image-turbo-df11，
# 其中包含 scheduler/、vae/、tokenizer/、text_encoder/、transformer/），
# Worker 会默认使用 DF11-only 推理模式，仅依赖该 DF11 仓库，而不再需要本地完整
# 浮点权重目录。
#
# 默认 DF11 根目录（如需放到别处，改这一行即可）：
Z_IMAGE_DF11_ROOT=models/z-image-turbo-df11
# 如需关闭 DF11（回退到完整浮点模型），可以显式设置：
# Z_IMAGE_USE_DF11=0
# 或者使用其他变体时自行控制。
#
# 默认还会开启 DF11 的 CPU offload，以尽量避免显存 OOM；
# 如果希望牺牲显存换更高吞吐，可以把下面的值改为 0。
Z_IMAGE_DF11_CPU_OFFLOAD=1            # 对 transformer 启用 DF11 CPU offload
Z_IMAGE_TEXT_DF11_CPU_OFFLOAD=1       # 对 text_encoder 启用 DF11 CPU offload

# ---- Celery Worker 并发度 ----
# 单个 Celery worker 的并发进程数，默认 1。
# 由于 Z-Image 推理（尤其是 DF11-only 模式）对显存要求较高，推荐在单卡上保持 1，
# 仅在确认显存/吞吐有余量时，再尝试提升到 2 或更高。
# WORKER_CONCURRENCY=1
PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

# ---- 生成图片存储（Local / S3 / MinIO）----
# 默认存储后端为 local（落到本地磁盘 outputs/z-image-outputs）。
# 如需“平稳过渡到 MinIO / 上云”，推荐改为 s3，并配置下方 S3_* 变量：
#
# 本地磁盘（legacy）：
# Z_IMAGE_STORAGE_BACKEND=local
# Z_IMAGE_OUTPUT_DIR=outputs/z-image-outputs
#
# MinIO（推荐：infra/docker-compose.dev.yml 已内置 minio + 自动建桶）：
Z_IMAGE_STORAGE_BACKEND=s3
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET_NAME=z-image
# 可选：对象 Key 前缀（相当于“目录”），默认 z-image-outputs
S3_PREFIX=z-image-outputs
